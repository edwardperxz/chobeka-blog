{% extends 'base.html' %}
{% block content %}

<div class="w-full max-w-4xl mx-auto px-4 py-8">
  <!-- Page Header -->
  <div class="text-center mb-12">
    <h1 class="text-4xl font-extrabold text-gray-900 dark:text-white sm:text-5xl">
      Todos los Blogs
    </h1>
    <p class="mt-4 text-xl text-gray-600 dark:text-gray-300">
      Descubre las últimas publicaciones de nuestra comunidad
    </p>
  </div>

  <!-- Filter/Search Bar -->
  <form method="get" class="mb-8 bg-white/80 dark:bg-gray-800/80 rounded-2xl shadow-lg p-6 border border-gray-200 dark:border-gray-700 max-w-4xl mx-auto"
        id="filter-form">
    <div class="flex flex-col gap-4 md:grid md:grid-cols-3 md:gap-6">
      <div>
        <label for="search" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Buscar</label>
        <input type="text" name="search" id="search" value="{{ request.GET.search }}" placeholder="Título o contenido"
          class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white" />
      </div>
      <div>
        <label for="tag" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Tag</label>
        <input type="text" name="tag" id="tag" value="{{ request.GET.tag }}" placeholder="Tag"
          class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white" />
      </div>
      <div>
        <label for="author" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Autor</label>
        <input type="text" name="author" id="author" value="{{ request.GET.author }}" placeholder="Usuario"
          class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white" />
      </div>
      <div>
        <label for="province" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Provincia</label>
        <select name="province" id="province"
          class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white appearance-none">
          <option value="">Todas las provincias</option>
          <option value="BOC" {% if request.GET.province == 'BOC' %}selected{% endif %}>Bocas del Toro</option>
          <option value="CHI" {% if request.GET.province == 'CHI' %}selected{% endif %}>Chiriquí</option>
          <option value="COC" {% if request.GET.province == 'COC' %}selected{% endif %}>Coclé</option>
          <option value="COL" {% if request.GET.province == 'COL' %}selected{% endif %}>Colón</option>
          <option value="DAR" {% if request.GET.province == 'DAR' %}selected{% endif %}>Darién</option>
          <option value="HER" {% if request.GET.province == 'HER' %}selected{% endif %}>Herrera</option>
          <option value="LOS" {% if request.GET.province == 'LOS' %}selected{% endif %}>Los Santos</option>
          <option value="PAN" {% if request.GET.province == 'PAN' %}selected{% endif %}>Panamá</option>
          <option value="VER" {% if request.GET.province == 'VER' %}selected{% endif %}>Veraguas</option>
          <option value="POE" {% if request.GET.province == 'POE' %}selected{% endif %}>Panamá Oeste</option>
        </select>
      </div>
      <div>
        <label for="date_from" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Desde</label>
        <input type="date" name="date_from" id="date_from" value="{{ request.GET.date_from }}"
          class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white" />
      </div>
      <div>
        <label for="date_to" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Hasta</label>
        <input type="date" name="date_to" id="date_to" value="{{ request.GET.date_to }}"
          class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white" />
      </div>
    </div>
    <div class="flex flex-col sm:flex-row gap-3 justify-end mt-6">
      <button type="submit" id="filter-submit"
        class="px-8 py-2.5 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200">
        Filtrar
      </button>
      <a href="{% url 'blogapp:blog_list' %}"
        class="px-8 py-2.5 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-full font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200 text-center">
        Limpiar
      </a>
    </div>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('filter-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const params = new URLSearchParams();
        let hasValues = false;

        // Añadir solo valores no vacíos a los parámetros de URL
        this.querySelectorAll('input, select').forEach(input => {
          if (input.value.trim()) {
            params.append(input.name, input.value.trim());
            hasValues = true;
          }
        });

        // Navegar a la URL filtrada o URL base si no hay filtros
        window.location.href = hasValues
          ? window.location.pathname + '?' + params.toString()
          : window.location.pathname;
      });
    });
  </script>

  <!-- Blog List -->
  <div class="grid gap-8 md:grid-cols-1 lg:grid-cols-1">
    {% for blog in object_list %}
    <article class="bg-primary_dark-100 hover:bg-primary_dark-300 dark:bg-primary_dark rounded-xl overflow-hidden hover:shadow-xl hover:dark:bg-secondary_dark transition-colors">
      <!-- Blog Header -->
      <div class="p-6 flex items-center justify-between flex-wrap gap-y-2">
        <!-- Foto, nombre, fecha, provincia -->
        <div class="flex items-center min-w-0 gap-2 flex-1 flex-wrap justify-start">
          <!-- Foto de perfil -->
          <a href="{% url 'blogapp:profile' blog.author.username %}" class="flex-shrink-0 group transition">
            {% if blog.author.profile.profile_photo %}
              <img src="{{ blog.author.profile.profile_photo.url }}" alt="{{ blog.author.username }}"
                   class="w-10 h-10 rounded-full object-cover border-2 border-gray-200 dark:border-gray-600 group-hover:border-blue-500 group-hover:ring-2 group-hover:ring-blue-300 dark:group-hover:border-blue-400 dark:group-hover:ring-blue-700 transition">
            {% else %}
              <span class="w-10 h-10 flex items-center justify-center rounded-full border-2 border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-400 group-hover:border-blue-500 group-hover:ring-2 group-hover:ring-blue-300 dark:group-hover:border-blue-400 dark:group-hover:ring-blue-700 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
              </span>
            {% endif %}
          </a>
          <!-- Nombre -->
          <a href="{% url 'blogapp:profile' blog.author.username %}" class="ml-2 font-medium text-secondary_dark dark:text-white truncate hover:text-blue-700 dark:hover:text-blue-300 transition group">
            {{ blog.author.username }}
          </a>
          <!-- Fecha -->
          <span class="ml-2 text-xs text-gray-500 dark:text-gray-400">{{ blog.created_at|date:"d M Y" }}</span>
          <!-- Provincia (con bandera si existe) -->
          {% for blog_content in blogs_list %}
            {% if blog_content.blog.id == blog.id and blog_content.location_info %}
              <a href="{% url 'blogapp:blog_list' %}?province={{ blog_content.location_code }}"
                 class="ml-2 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                 bg-{{ blog_content.location_info.color }}-100 text-{{ blog_content.location_info.color }}-800
                 dark:bg-{{ blog_content.location_info.color }}-900 dark:text-{{ blog_content.location_info.color }}-300
                 hover:bg-blue-100 hover:text-blue-800 dark:hover:bg-blue-900 dark:hover:text-blue-200 transition">
                {% if blog_content.location_info.flag_url %}
                  <img src="/static/flags/{{ blog_content.location_info.flag_url }}_flag.svg"
                       alt="{{ blog_content.location_info.name }} province flag"
                       class="h-4 w-auto mr-2 inline">
                {% endif %}
                {{ blog_content.location_info.name }}
              </a>
            {% endif %}
          {% endfor %}
        </div>
        <!-- Tres puntos -->
        <div class="relative flex-shrink-0 ml-2">
          <button class="p-1 rounded-full hover:bg-gray-400 dark:hover:bg-gray-700 focus:outline-none"
                  id="menu-button-{{ blog.pk }}" aria-expanded="false" aria-haspopup="true">
            <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <circle cx="5" cy="12" r="1.5"/>
              <circle cx="12" cy="12" r="1.5"/>
              <circle cx="19" cy="12" r="1.5"/>
            </svg>
          </button>
          <div class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10"
               id="menu-dropdown-{{ blog.pk }}" role="menu" aria-orientation="vertical">
            <div class="py-1">
              {% if user.is_authenticated %}
                {% if user == blog.author %}
                  <a href="{% url 'blogapp:edit_blog' blog.pk %}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">
                    <i class="fas fa-edit mr-2"></i> Editar
                  </a>
                  <a href="{% url 'blogapp:delete_blog' blog.pk %}" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">
                    <i class="fas fa-trash-alt mr-2"></i> Eliminar
                  </a>
                {% else %}
                  <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">
                    <i class="fas fa-share-alt mr-2"></i> Compartir
                  </a>
                  <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">
                    <i class="fas fa-bookmark mr-2"></i> Guardar
                  </a>
                  <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">
                    <i class="fas fa-eye-slash mr-2"></i> Ocultar
                  </a>
                  <a href="#" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">
                    <i class="fas fa-flag mr-2"></i> Denunciar
                  </a>
                {% endif %}
              {% else %}
                <a href="#" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">
                  <i class="fas fa-flag mr-2"></i> Denunciar
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Título -->
      <a href="{% url 'blogapp:blog_detail' blog.pk %}" class="block group px-6 pt-2 -mt-4">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2 group-hover:text-primary_dark-600 dark:group-hover:text-red-500 transition-colors break-words">
          {{ blog.title }}
        </h2>
      </a>

      <!-- Tags -->
      {% for blog_content in blogs_list %}
        {% if blog_content.blog.id == blog.id and blog_content.blog_tags %}
        <div class="px-6 pb-2">
          <div class="flex flex-wrap gap-2">
            {% for tag in blog_content.blog_tags %}
            <a href="{% url 'blogapp:blog_list' %}?tag={{ tag|cut:'#' }}"
               class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200 hover:bg-blue-200 hover:text-blue-900 dark:hover:bg-blue-800 dark:hover:text-blue-200 transition">
              {{ tag }}
            </a>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      {% endfor %}

      <!-- Blog Content -->
      <div class="px-6 pb-6">
        <a href="{% url 'blogapp:blog_detail' blog.pk %}" class="block group">
          <p class="text-gray-600 dark:text-gray-300 mb-6 line-clamp-3">
            {{ blog.content|striptags|truncatewords:30 }}
          </p>
        </a>

        <!-- Blog Image -->
        {% if blog.image %}
        <div class="mb-6 rounded-lg overflow-hidden">
          <a href="{% url 'blogapp:blog_detail' blog.pk %}" class="block group">
            <div class="relative aspect-w-16 aspect-h-9 bg-gray-200 dark:bg-gray-700">
              <img src="{{ blog.image.url }}" alt="{{ blog.title }}"
                   class="object-cover w-full h-full group-hover:opacity-90 transition-opacity">
              <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent"></div>
            </div>
          </a>
        </div>
        {% endif %}

        <!-- Footer: Comentarios y Rating -->
        <div class="flex items-center justify-between mt-4 flex-wrap gap-y-2">
          <!-- Botón comentarios -->
          <a href="{% url 'blogapp:blog_detail' blog.pk %}#comments"
             class="flex items-center px-3 py-1 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-blue-100 hover:text-blue-900 dark:hover:bg-blue-800 dark:hover:text-blue-200 transition">
            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
            </svg>
            {% for blog_content in blogs_list %}
              {% if blog_content.blog.id == blog.id %}
                {{ blog_content.comments_count }}
              {% endif %}
            {% endfor %}
          </a>
          <!-- Rating -->
          {% for blog_content in blogs_list %}
            {% if blog_content.blog.id == blog.id %}
              {% if blog_content.avg_rating > 0 %}
                <div class="flex items-center ml-4">
                  <div class="flex items-center mr-2">
                    {% for i in "12345" %}
                      {% if forloop.counter <= blog_content.avg_rating %}
                      <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                      </svg>
                      {% else %}
                      <svg class="w-5 h-5 text-gray-300 dark:text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                      </svg>
                      {% endif %}
                    {% endfor %}
                  </div>
                  <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                    {{ blog_content.avg_rating|floatformat:1 }} ({{ blog_content.review_count }} review{{ blog_content.review_count|pluralize }})
                  </span>
                </div>
              {% else %}
                <span class="text-sm text-gray-900 dark:text-gray-400 ml-4">Sin calificaciones moh</span>
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </article>
    {% empty %}
    <div class="col-span-full text-center py-12">
      <div class="mx-auto w-24 h-24 text-gray-400 dark:text-gray-500 mb-4">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      <h3 class="text-lg font-medium text-gray-900 dark:text-white">Sin blogs que ver.</h3>
      <p class="mt-2 text-gray-500 dark:text-gray-400">SUBE ALGO MO!</p>
      {% if user.is_authenticated %}
      <div class="mt-6">
        <a href="{% url 'blogapp:add_blog' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
          Crear tu primer Blogazo
        </a>
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  {% if is_paginated %}
  <div class="mt-12 flex justify-center">
    <nav class="flex items-center space-x-2">
      {% if page_obj.has_previous %}
        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-white dark:hover:bg-gray-700">
          &larr; Previous
        </a>
      {% else %}
        <span class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-400 bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-gray-500 cursor-not-allowed">
          &larr; Previous
        </span>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
          <span class="inline-flex items-center px-4 py-2 border border-red-500 text-sm font-medium rounded-md text-white bg-red-500">
            {{ num }}
          </span>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-white dark:hover:bg-gray-700">
            {{ num }}
          </a>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-white dark:hover:bg-gray-700">
          Next &rarr;
        </a>
      {% else %}
        <span class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-400 bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-gray-500 cursor-not-allowed">
          Next &rarr;
        </span>
      {% endif %}
    </nav>
  </div>
  {% endif %}
</div>

<script>
  // Funcionalidad del Dropdown
  document.querySelectorAll('[id^="menu-button-"]').forEach(button => {
    button.addEventListener('click', function(e) {
      e.stopPropagation();
      const dropdownId = this.id.replace('menu-button', 'menu-dropdown');
      const dropdown = document.getElementById(dropdownId);

      // Cerrar todos los otros Dropdowns
      document.querySelectorAll('[id^="menu-dropdown-"]').forEach(d => {
        if (d.id !== dropdownId) d.classList.add('hidden');
      });

      // Alternar visibilidad del menú actual
      dropdown.classList.toggle('hidden');
    });
  });

  // Cerrar el Dropdown cuando se hace clic afuera
  document.addEventListener('click', function() {
    document.querySelectorAll('[id^="menu-dropdown-"]').forEach(dropdown => {
      dropdown.classList.add('hidden');
    });
  });
</script>

{% endblock %}